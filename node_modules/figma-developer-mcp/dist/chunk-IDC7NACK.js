import{a as c,b as $}from"./chunk-Q77VG2BX.js";import{c as Z,d as P,e as D,f as k}from"./chunk-HDFA5JOA.js";import{StdioServerTransport as xt}from"@modelcontextprotocol/sdk/server/stdio.js";import{config as It}from"dotenv";import{resolve as Tt}from"path";import{config as Ee}from"dotenv";import Ne from"yargs";import{hideBin as $e}from"yargs/helpers";import{resolve as Q}from"path";function ee(e){return!e||e.length<=4?"****":`****${e.slice(-4)}`}function te(e){let t=Ne($e(process.argv)).options({"figma-api-key":{type:"string",description:"Figma API key (Personal Access Token)"},"figma-oauth-token":{type:"string",description:"Figma OAuth Bearer token"},env:{type:"string",description:"Path to custom .env file to load environment variables from"},port:{type:"number",description:"Port to run the server on"},json:{type:"boolean",description:"Output data from tools in JSON format instead of YAML",default:!1},"skip-image-downloads":{type:"boolean",description:"Do not register the download_figma_images tool (skip image downloads)",default:!1}}).help().version("0.6.0").parseSync(),o,n;t.env?(o=Q(t.env),n="cli"):(o=Q(process.cwd(),".env"),n="default"),Ee({path:o,override:!0});let r={figmaApiKey:"",figmaOAuthToken:"",useOAuth:!1},i={port:3333,outputFormat:"yaml",skipImageDownloads:!1,configSources:{figmaApiKey:"env",figmaOAuthToken:"none",port:"default",outputFormat:"default",envFile:n,skipImageDownloads:"default"}};return t["figma-api-key"]?(r.figmaApiKey=t["figma-api-key"],i.configSources.figmaApiKey="cli"):process.env.FIGMA_API_KEY&&(r.figmaApiKey=process.env.FIGMA_API_KEY,i.configSources.figmaApiKey="env"),t["figma-oauth-token"]?(r.figmaOAuthToken=t["figma-oauth-token"],i.configSources.figmaOAuthToken="cli",r.useOAuth=!0):process.env.FIGMA_OAUTH_TOKEN&&(r.figmaOAuthToken=process.env.FIGMA_OAUTH_TOKEN,i.configSources.figmaOAuthToken="env",r.useOAuth=!0),t.port?(i.port=t.port,i.configSources.port="cli"):process.env.PORT&&(i.port=parseInt(process.env.PORT,10),i.configSources.port="env"),t.json?(i.outputFormat="json",i.configSources.outputFormat="cli"):process.env.OUTPUT_FORMAT&&(i.outputFormat=process.env.OUTPUT_FORMAT,i.configSources.outputFormat="env"),t["skip-image-downloads"]?(i.skipImageDownloads=!0,i.configSources.skipImageDownloads="cli"):process.env.SKIP_IMAGE_DOWNLOADS==="true"&&(i.skipImageDownloads=!0,i.configSources.skipImageDownloads="env"),!r.figmaApiKey&&!r.figmaOAuthToken&&(console.error("Either FIGMA_API_KEY or FIGMA_OAUTH_TOKEN is required (via CLI argument or .env file)"),process.exit(1)),e||(console.log(`
Configuration:`),console.log(`- ENV_FILE: ${o} (source: ${i.configSources.envFile})`),r.useOAuth?(console.log(`- FIGMA_OAUTH_TOKEN: ${ee(r.figmaOAuthToken)} (source: ${i.configSources.figmaOAuthToken})`),console.log("- Authentication Method: OAuth Bearer Token")):(console.log(`- FIGMA_API_KEY: ${ee(r.figmaApiKey)} (source: ${i.configSources.figmaApiKey})`),console.log("- Authentication Method: Personal Access Token (X-Figma-Token)")),console.log(`- PORT: ${i.port} (source: ${i.configSources.port})`),console.log(`- OUTPUT_FORMAT: ${i.outputFormat} (source: ${i.configSources.outputFormat})`),console.log(`- SKIP_IMAGE_DOWNLOADS: ${i.skipImageDownloads} (source: ${i.configSources.skipImageDownloads})`),console.log()),{...i,auth:r}}import{randomUUID as ke}from"node:crypto";import oe from"express";import{SSEServerTransport as Ce}from"@modelcontextprotocol/sdk/server/sse.js";import{StreamableHTTPServerTransport as Pe}from"@modelcontextprotocol/sdk/server/streamableHttp.js";import{isInitializeRequest as Oe}from"@modelcontextprotocol/sdk/types.js";import"@modelcontextprotocol/sdk/server/mcp.js";var Ge=null,R={streamable:{},sse:{}};async function ne(e,t){let o=oe();o.use("/mcp",oe.json()),o.post("/mcp",async(r,i)=>{c.log("Received StreamableHTTP request");let s=r.headers["mcp-session-id"],a;if(s&&R.streamable[s])c.log("Reusing existing StreamableHTTP transport for sessionId",s),a=R.streamable[s];else if(!s&&Oe(r.body))c.log("New initialization request for StreamableHTTP sessionId",s),a=new Pe({sessionIdGenerator:()=>ke(),onsessioninitialized:f=>{R.streamable[f]=a}}),a.onclose=()=>{a.sessionId&&delete R.streamable[a.sessionId]},await t.connect(a);else{c.log("Invalid request:",r.body),i.status(400).json({jsonrpc:"2.0",error:{code:-32e3,message:"Bad Request: No valid session ID provided"},id:null});return}let l=null,m=r.body.params?._meta?.progressToken,g=0;m&&(c.log(`Setting up progress notifications for token ${m} on session ${s}`),l=setInterval(async()=>{c.log("Sending progress notification",g),await t.server.notification({method:"notifications/progress",params:{progress:g,progressToken:m}}),g++},1e3)),c.log("Handling StreamableHTTP request"),await a.handleRequest(r,i,r.body),l&&clearInterval(l),c.log("StreamableHTTP request handled")});let n=async(r,i)=>{let s=r.headers["mcp-session-id"];if(!s||!R.streamable[s]){i.status(400).send("Invalid or missing session ID");return}console.log(`Received session termination request for session ${s}`);try{await R.streamable[s].handleRequest(r,i)}catch(a){console.error("Error handling session termination:",a),i.headersSent||i.status(500).send("Error processing session termination")}};o.get("/mcp",n),o.delete("/mcp",n),o.get("/sse",async(r,i)=>{c.log("Establishing new SSE connection");let s=new Ce("/messages",i);c.log(`New SSE connection established for sessionId ${s.sessionId}`),c.log("/sse request headers:",r.headers),c.log("/sse request body:",r.body),R.sse[s.sessionId]=s,i.on("close",()=>{delete R.sse[s.sessionId]}),await t.connect(s)}),o.post("/messages",async(r,i)=>{let s=r.query.sessionId,a=R.sse[s];if(a)c.log(`Received SSE message for sessionId ${s}`),c.log("/messages request headers:",r.headers),c.log("/messages request body:",r.body),await a.handlePostMessage(r,i);else{i.status(400).send(`No transport found for sessionId ${s}`);return}}),Ge=o.listen(e,()=>{c.log(`HTTP server listening on port ${e}`),c.log(`SSE endpoint available at http://localhost:${e}/sse`),c.log(`Message endpoint available at http://localhost:${e}/messages`),c.log(`StreamableHTTP endpoint available at http://localhost:${e}/mcp`)}),process.on("SIGINT",async()=>{c.log("Shutting down server..."),await re(R.sse),await re(R.streamable),c.log("Server shutdown complete"),process.exit(0)})}async function re(e){for(let t in e)try{await e[t]?.close(),delete e[t]}catch(o){console.error(`Error closing transport for session ${t}:`,o)}}import{McpServer as yt}from"@modelcontextprotocol/sdk/server/mcp.js";import _ from"path";import Me from"fs";import se from"sharp";async function Le(e,t){let{Logger:o}=await import("./logger-RNG6OBLU.js");try{let n=t[0]?.[0]??1,r=t[0]?.[1]??0,i=t[0]?.[2]??0,s=t[1]?.[0]??0,a=t[1]?.[1]??1,l=t[1]?.[2]??0,m=se(e),g=await m.metadata();if(!g.width||!g.height)throw new Error(`Could not get image dimensions for ${e}`);let{width:f,height:p}=g,u=Math.max(0,Math.round(i*f)),h=Math.max(0,Math.round(l*p)),d=Math.min(f-u,Math.round(n*f)),y=Math.min(p-h,Math.round(a*p));if(d<=0||y<=0)return o.log(`Invalid crop dimensions for ${e}, using original image`),e;let S=e+".tmp";return await m.extract({left:u,top:h,width:d,height:y}).toFile(S),Me.renameSync(S,e),o.log(`Cropped image saved (overwritten): ${e}`),o.log(`Crop region: ${u}, ${h}, ${d}x${y} from ${f}x${p}`),e}catch(n){return o.error(`Error cropping image ${e}:`,n),e}}async function ie(e){let{Logger:t}=await import("./logger-RNG6OBLU.js");try{let o=await se(e).metadata();if(!o.width||!o.height)throw new Error(`Could not get image dimensions for ${e}`);return{width:o.width,height:o.height}}catch(o){return t.error(`Error getting image dimensions for ${e}:`,o),{width:1e3,height:1e3}}}async function O(e,t,o,n=!1,r,i=!1){let{Logger:s}=await import("./logger-RNG6OBLU.js"),a=[],{downloadFigmaImage:l}=await import("./common-D7KV4EZS.js"),m=await l(e,t,o);s.log(`Downloaded original image: ${m}`);let g=await ie(m);s.log(`Original dimensions: ${g.width}x${g.height}`);let f=m,p=!1,u;if(n&&r){s.log("Applying crop transform...");let y=r[0]?.[0]??1,S=r[1]?.[1]??1,w=r[0]?.[2]??0,A=r[1]?.[2]??0,x=Math.max(0,Math.round(w*g.width)),F=Math.max(0,Math.round(A*g.height)),v=Math.min(g.width-x,Math.round(y*g.width)),j=Math.min(g.height-F,Math.round(S*g.height));v>0&&j>0?(u={left:x,top:F,width:v,height:j},f=await Le(m,r),p=!0,s.log(`Cropped to region: ${x}, ${F}, ${v}x${j}`)):s.log("Invalid crop dimensions, keeping original image")}let h=await ie(f);s.log(`Final dimensions: ${h.width}x${h.height}`);let d;return i&&(d=Ve(h)),{filePath:f,originalDimensions:g,finalDimensions:h,wasCropped:p,cropRegion:u,cssVariables:d,processingLog:a}}function Ve({width:e,height:t}){return`--original-width: ${e}px; --original-height: ${t}px;`}import{exec as Be}from"child_process";import{promisify as He}from"util";var je=He(Be);async function ae(e,t={}){try{let o=await fetch(e,t);if(!o.ok)throw new Error(`Fetch failed with status ${o.status}: ${o.statusText}`);return await o.json()}catch(o){c.log(`[fetchWithRetry] Initial fetch failed for ${e}: ${o.message}. Likely a corporate proxy or SSL issue. Attempting curl fallback.`);let r=`curl -s -S --fail-with-body -L ${_e(t.headers).join(" ")} "${e}"`;try{c.log(`[fetchWithRetry] Executing curl command: ${r}`);let{stdout:i,stderr:s}=await je(r);if(s){if(!i||s.toLowerCase().includes("error")||s.toLowerCase().includes("fail"))throw new Error(`Curl command failed with stderr: ${s}`);c.log(`[fetchWithRetry] Curl command for ${e} produced stderr (but might be informational): ${s}`)}if(!i)throw new Error("Curl command returned empty stdout.");let a=JSON.parse(i);if(a.status&&a.status!==200)throw new Error(`Curl command failed: ${a}`);return a}catch(i){throw c.error(`[fetchWithRetry] Curl fallback also failed for ${e}: ${i.message}`),o}}}function _e(e){return e?Object.entries(e).map(([t,o])=>`-H "${t}: ${o}"`):[]}var G=class{apiKey;oauthToken;useOAuth;baseUrl="https://api.figma.com/v1";constructor({figmaApiKey:t,figmaOAuthToken:o,useOAuth:n}){this.apiKey=t||"",this.oauthToken=o||"",this.useOAuth=!!n&&!!this.oauthToken}getAuthHeaders(){return this.useOAuth?(c.log("Using OAuth Bearer token for authentication"),{Authorization:`Bearer ${this.oauthToken}`}):(c.log("Using Personal Access Token for authentication"),{"X-Figma-Token":this.apiKey})}filterValidImages(t){return t?Object.fromEntries(Object.entries(t).filter(([,o])=>!!o)):{}}async request(t){try{c.log(`Calling ${this.baseUrl}${t}`);let o=this.getAuthHeaders();return await ae(`${this.baseUrl}${t}`,{headers:o})}catch(o){let n=o instanceof Error?o.message:String(o);throw new Error(`Failed to make request to Figma API endpoint '${t}': ${n}`)}}buildSvgQueryParams(t,o){return new URLSearchParams({ids:t.join(","),format:"svg",svg_outline_text:String(o.outlineText),svg_include_id:String(o.includeId),svg_simplify_stroke:String(o.simplifyStroke)}).toString()}async getImageFillUrls(t){let o=`/files/${t}/images`;return(await this.request(o)).meta.images||{}}async getNodeRenderUrls(t,o,n,r={}){if(o.length===0)return{};if(n==="png"){let i=r.pngScale||2,s=`/images/${t}?ids=${o.join(",")}&format=png&scale=${i}`,a=await this.request(s);return this.filterValidImages(a.images)}else{let i=r.svgOptions||{outlineText:!0,includeId:!1,simplifyStroke:!0},s=this.buildSvgQueryParams(o,i),a=`/images/${t}?${s}`,l=await this.request(a);return this.filterValidImages(l.images)}}async downloadImages(t,o,n,r={}){if(n.length===0)return[];let i=_.normalize(o).replace(/^(\.\.(\/|\\|$))+/,""),s=_.resolve(i);if(!s.startsWith(_.resolve(process.cwd())))throw new Error("Invalid path specified. Directory traversal is not allowed.");let{pngScale:a=2,svgOptions:l}=r,m=[],g=n.filter(u=>!!u.imageRef),f=n.filter(u=>!!u.nodeId);if(g.length>0){let u=await this.getImageFillUrls(t),h=g.map(({imageRef:d,fileName:y,needsCropping:S,cropTransform:w,requiresImageDimensions:A})=>{let x=u[d];return x?O(y,s,x,S,w,A):null}).filter(d=>d!==null);h.length>0&&m.push(Promise.all(h))}if(f.length>0){let u=f.filter(d=>!d.fileName.toLowerCase().endsWith(".svg")),h=f.filter(d=>d.fileName.toLowerCase().endsWith(".svg"));if(u.length>0){let d=await this.getNodeRenderUrls(t,u.map(S=>S.nodeId),"png",{pngScale:a}),y=u.map(({nodeId:S,fileName:w,needsCropping:A,cropTransform:x,requiresImageDimensions:F})=>{let v=d[S];return v?O(w,s,v,A,x,F):null}).filter(S=>S!==null);y.length>0&&m.push(Promise.all(y))}if(h.length>0){let d=await this.getNodeRenderUrls(t,h.map(S=>S.nodeId),"svg",{svgOptions:l}),y=h.map(({nodeId:S,fileName:w,needsCropping:A,cropTransform:x,requiresImageDimensions:F})=>{let v=d[S];return v?O(w,s,v,A,x,F):null}).filter(S=>S!==null);y.length>0&&m.push(Promise.all(y))}}return(await Promise.all(m)).flat()}async getRawFile(t,o){let n=`/files/${t}${o?`?depth=${o}`:""}`;c.log(`Retrieving raw Figma file: ${t} (depth: ${o??"default"})`);let r=await this.request(n);return $("figma-raw.json",r),r}async getRawNode(t,o,n){let r=`/files/${t}/nodes?ids=${o}${n?`&depth=${n}`:""}`;c.log(`Retrieving raw Figma node: ${o} from ${t} (depth: ${n??"default"})`);let i=await this.request(r);return $("figma-raw.json",i),i}};import{z as H}from"zod";import{isTruthy as le}from"remeda";function b(e,t,o){if(!(typeof t=="object"&&t!==null)||!(e in t))return!1;let r=t[e];return o?o(r):r!==void 0}function M(e){return typeof e=="object"&&!!e&&"clipsContent"in e&&typeof e.clipsContent=="boolean"}function z(e){return typeof e=="object"&&!!e&&"absoluteBoundingBox"in e&&typeof e.absoluteBoundingBox=="object"&&!!e.absoluteBoundingBox&&"x"in e.absoluteBoundingBox&&"y"in e.absoluteBoundingBox&&"width"in e.absoluteBoundingBox&&"height"in e.absoluteBoundingBox}function ce(e,t){let o=["HORIZONTAL","VERTICAL"];return M(t)&&o.includes(t.layoutMode??"NONE")&&z(e)&&e.layoutPositioning!=="ABSOLUTE"}function me(e){return typeof e=="object"&&e!==null&&"top"in e&&"right"in e&&"bottom"in e&&"left"in e}function ge(e,t){let o=t;return typeof t=="object"&&!!t&&e in o&&typeof o[e]=="object"&&!!o[e]&&"x"in o[e]&&"y"in o[e]&&"width"in o[e]&&"height"in o[e]}function pe(e){return Array.isArray(e)&&e.length===4&&e.every(t=>typeof t=="number")}function W(e,t,o={},n={styles:{}}){let r={globalVars:n,currentDepth:0};return{nodes:e.filter(s=>U(s,o)).map(s=>ue(s,t,r,o)).filter(s=>s!==null),globalVars:r.globalVars}}function ue(e,t,o,n){if(!U(e,n))return null;let r={id:e.id,name:e.name,type:e.type==="VECTOR"?"IMAGE-SVG":e.type};for(let i of t)i(e,r,o);if(ze(e,o,n)){let i={...o,currentDepth:o.currentDepth+1,parent:e};if(b("children",e)&&e.children.length>0){let s=e.children.filter(a=>U(a,n)).map(a=>ue(a,t,i,n)).filter(a=>a!==null);s.length>0&&(r.children=s)}}return r}function U(e,t){return!(!D(e)||t.nodeFilter&&!t.nodeFilter(e))}function ze(e,t,o){return!(o.maxDepth!==void 0&&t.currentDepth>=o.maxDepth)}function de(e){return Object.fromEntries(Object.entries(e).map(([t,o])=>[t,{id:t,key:o.key,name:o.name,componentSetId:o.componentSetId}]))}function fe(e){return Object.fromEntries(Object.entries(e).map(([t,o])=>[t,{id:t,key:o.key,name:o.name,description:o.description}]))}function q(e,t,o={}){let{metadata:n,rawNodes:r,components:i,componentSets:s,extraStyles:a}=Ue(e),l={styles:{},extraStyles:a},{nodes:m,globalVars:g}=W(r,t,o,l);return{...n,nodes:m,components:de(i),componentSets:fe(s),globalVars:{styles:g.styles}}}function Ue(e){let t={},o={},n={},r;if("nodes"in e){let l=Object.values(e.nodes);l.forEach(m=>{m.components&&Object.assign(t,m.components),m.componentSets&&Object.assign(o,m.componentSets),m.styles&&Object.assign(n,m.styles)}),r=l.map(m=>m.document).filter(D)}else Object.assign(t,e.components),Object.assign(o,e.componentSets),e.styles&&(n=e.styles),r=e.document.children.filter(D);let{name:i,lastModified:s,thumbnailUrl:a}=e;return{metadata:{name:i,lastModified:s,thumbnailUrl:a||""},rawNodes:r,extraStyles:n,components:t,componentSets:o}}function Se(e,t){let o=Ke(e),n=Xe(e,t,o.mode)||{};return{...o,...n}}function he(e,t){if(t&&t.mode!=="none"){let{children:o,mode:n,axis:r}=t,i=qe(r,n);if(o.length>0&&o.reduce((a,l)=>a?"layoutPositioning"in l&&l.layoutPositioning==="ABSOLUTE"?!0:i==="horizontal"?"layoutSizingHorizontal"in l&&l.layoutSizingHorizontal==="FILL":i==="vertical"?"layoutSizingVertical"in l&&l.layoutSizingVertical==="FILL":!1:!1,!0))return"stretch"}switch(e){case"MIN":return;case"MAX":return"flex-end";case"CENTER":return"center";case"SPACE_BETWEEN":return"space-between";case"BASELINE":return"baseline";default:return}}function We(e){switch(e){case"MIN":return;case"MAX":return"flex-end";case"CENTER":return"center";case"STRETCH":return"stretch";default:return}}function ye(e){if(e==="FIXED")return"fixed";if(e==="FILL")return"fill";if(e==="HUG")return"hug"}function qe(e,t){switch(e){case"primary":switch(t){case"row":return"horizontal";case"column":return"vertical"}case"counter":switch(t){case"row":return"horizontal";case"column":return"vertical"}}}function Ke(e){if(!M(e))return{mode:"none"};let t={mode:!e.layoutMode||e.layoutMode==="NONE"?"none":e.layoutMode==="HORIZONTAL"?"row":"column"},o=[];return e.overflowDirection?.includes("HORIZONTAL")&&o.push("x"),e.overflowDirection?.includes("VERTICAL")&&o.push("y"),o.length>0&&(t.overflowScroll=o),t.mode==="none"||(t.justifyContent=he(e.primaryAxisAlignItems??"MIN",{children:e.children,axis:"primary",mode:t.mode}),t.alignItems=he(e.counterAxisAlignItems??"MIN",{children:e.children,axis:"counter",mode:t.mode}),t.alignSelf=We(e.layoutAlign),t.wrap=e.layoutWrap==="WRAP"?!0:void 0,t.gap=e.itemSpacing?`${e.itemSpacing??0}px`:void 0,(e.paddingTop||e.paddingBottom||e.paddingLeft||e.paddingRight)&&(t.padding=P({top:e.paddingTop??0,right:e.paddingRight??0,bottom:e.paddingBottom??0,left:e.paddingLeft??0}))),t}function Xe(e,t,o){if(!z(e))return;let n={mode:o};if(n.sizing={horizontal:ye(e.layoutSizingHorizontal),vertical:ye(e.layoutSizingVertical)},M(t)&&!ce(e,t)&&(e.layoutPositioning==="ABSOLUTE"&&(n.position="absolute"),e.absoluteBoundingBox&&t.absoluteBoundingBox&&(n.locationRelativeToParent={x:k(e.absoluteBoundingBox.x-t.absoluteBoundingBox.x),y:k(e.absoluteBoundingBox.y-t.absoluteBoundingBox.y)})),ge("absoluteBoundingBox",e)){let r={};o==="row"?(!e.layoutGrow&&e.layoutSizingHorizontal=="FIXED"&&(r.width=e.absoluteBoundingBox.width),e.layoutAlign!=="STRETCH"&&e.layoutSizingVertical=="FIXED"&&(r.height=e.absoluteBoundingBox.height)):o==="column"?(e.layoutAlign!=="STRETCH"&&e.layoutSizingHorizontal=="FIXED"&&(r.width=e.absoluteBoundingBox.width),!e.layoutGrow&&e.layoutSizingVertical=="FIXED"&&(r.height=e.absoluteBoundingBox.height),e.preserveRatio&&(r.aspectRatio=e.absoluteBoundingBox?.width/e.absoluteBoundingBox?.height)):((!e.layoutSizingHorizontal||e.layoutSizingHorizontal==="FIXED")&&(r.width=e.absoluteBoundingBox.width),(!e.layoutSizingVertical||e.layoutSizingVertical==="FIXED")&&(r.height=e.absoluteBoundingBox.height)),Object.keys(r).length>0&&(r.width&&(r.width=k(r.width)),r.height&&(r.height=k(r.height)),n.dimensions=r)}return n}function Ye(e,t,o){let n=t;switch(e){case"FILL":return{css:n?{backgroundSize:"cover",backgroundRepeat:"no-repeat",isBackground:!0}:{objectFit:"cover",isBackground:!1},processing:{needsCropping:!1,requiresImageDimensions:!1}};case"FIT":return{css:n?{backgroundSize:"contain",backgroundRepeat:"no-repeat",isBackground:!0}:{objectFit:"contain",isBackground:!1},processing:{needsCropping:!1,requiresImageDimensions:!1}};case"TILE":return{css:{backgroundRepeat:"repeat",backgroundSize:o?`calc(var(--original-width) * ${o}) calc(var(--original-height) * ${o})`:"auto",isBackground:!0},processing:{needsCropping:!1,requiresImageDimensions:!0}};case"STRETCH":return{css:n?{backgroundSize:"100% 100%",backgroundRepeat:"no-repeat",isBackground:!0}:{objectFit:"fill",isBackground:!1},processing:{needsCropping:!1,requiresImageDimensions:!1}};default:return{css:{},processing:{needsCropping:!1,requiresImageDimensions:!1}}}}function Je(e){let o=e.flat().reduce((n,r)=>{let i=r.toString();for(let s=0;s<i.length;s++)n=(n<<5)-n+i.charCodeAt(s)&4294967295;return n},0);return Math.abs(o).toString(16).substring(0,6)}function Ze(e){let t=Je(e);return{needsCropping:!0,requiresImageDimensions:!1,cropTransform:e,filenameSuffix:`${t}`}}function be(e,t=!1){let o={colors:[]};return b("strokes",e)&&Array.isArray(e.strokes)&&e.strokes.length&&(o.colors=e.strokes.filter(D).map(n=>K(n,t))),b("strokeWeight",e)&&typeof e.strokeWeight=="number"&&e.strokeWeight>0&&(o.strokeWeight=`${e.strokeWeight}px`),b("strokeDashes",e)&&Array.isArray(e.strokeDashes)&&e.strokeDashes.length&&(o.strokeDashes=e.strokeDashes),b("individualStrokeWeights",e,me)&&(o.strokeWeight=P(e.individualStrokeWeights)),o}function K(e,t=!1){if(e.type==="IMAGE"){let o={type:"IMAGE",imageRef:e.imageRef,scaleMode:e.scaleMode,scalingFactor:e.scalingFactor},n=t||o.scaleMode==="TILE",{css:r,processing:i}=Ye(o.scaleMode,n,e.scalingFactor),s=i;if(e.imageTransform){let a=Ze(e.imageTransform);s={...i,...a,requiresImageDimensions:i.requiresImageDimensions||a.requiresImageDimensions}}return{...o,...r,imageDownloadArguments:s}}else if(e.type==="SOLID"){let{hex:o,opacity:n}=et(e.color,e.opacity);return n===1?o:T(e.color,n)}else{if(e.type==="PATTERN")return Qe(e);if(["GRADIENT_LINEAR","GRADIENT_RADIAL","GRADIENT_ANGULAR","GRADIENT_DIAMOND"].includes(e.type))return{type:e.type,gradient:at(e)};throw new Error(`Unknown paint type: ${e.type}`)}}function Qe(e){let t="repeat",o="left";switch(e.horizontalAlignment){case"START":o="left";break;case"CENTER":o="center";break;case"END":o="right";break}let n="top";switch(e.verticalAlignment){case"START":n="top";break;case"CENTER":n="center";break;case"END":n="bottom";break}return{type:e.type,patternSource:{type:"IMAGE-PNG",nodeId:e.sourceNodeId},backgroundRepeat:t,backgroundSize:`${Math.round(e.scalingFactor*100)}%`,backgroundPosition:`${o} ${n}`}}function et(e,t=1){let o=Math.round(e.r*255),n=Math.round(e.g*255),r=Math.round(e.b*255),i=Math.round(t*e.a*100)/100;return{hex:"#"+((1<<24)+(o<<16)+(n<<8)+r).toString(16).slice(1).toUpperCase(),opacity:i}}function T(e,t=1){let o=Math.round(e.r*255),n=Math.round(e.g*255),r=Math.round(e.b*255),i=Math.round(t*e.a*100)/100;return`rgba(${o}, ${n}, ${r}, ${i})`}function tt(e,t={width:1,height:1}){let o=e.gradientHandlePositions;if(!o||o.length<2)return{stops:e.gradientStops.map(({position:a,color:l})=>`${T(l,1)} ${Math.round(a*100)}%`).join(", "),cssGeometry:"0deg"};let[n,r,i]=o;switch(e.type){case"GRADIENT_LINEAR":return ot(e.gradientStops,n,r,t);case"GRADIENT_RADIAL":return nt(e.gradientStops,n,r,i,t);case"GRADIENT_ANGULAR":return it(e.gradientStops,n,r,i,t);case"GRADIENT_DIAMOND":return st(e.gradientStops,n,r,i,t);default:return{stops:e.gradientStops.map(({position:a,color:l})=>`${T(l,1)} ${Math.round(a*100)}%`).join(", "),cssGeometry:"0deg"}}}function ot(e,t,o,n){let r=o.x-t.x,i=o.y-t.y;if(Math.sqrt(r*r+i*i)===0)return{stops:e.map(({position:f,color:p})=>`${T(p,1)} ${Math.round(f*100)}%`).join(", "),cssGeometry:"0deg"};let a=Math.atan2(i,r)*(180/Math.PI)+90,l=rt(t,o);if(l.length>=2){let g=Math.min(l[0],l[1]),f=Math.max(l[0],l[1]),p=f-g;return{stops:e.map(({position:h,color:d})=>{let y=T(d,1),A=(h*1+0-g)/(f-g),x=Math.max(0,Math.min(1,A));return`${y} ${Math.round(x*100)}%`}).join(", "),cssGeometry:`${Math.round(a)}deg`}}return{stops:e.map(({position:g,color:f})=>`${T(f,1)} ${Math.round(g*100)}%`).join(", "),cssGeometry:`${Math.round(a)}deg`}}function rt(e,t){let o=t.x-e.x,n=t.y-e.y;if(Math.abs(o)<1e-10&&Math.abs(n)<1e-10)return[];let r=[];if(Math.abs(n)>1e-10){let s=-e.y/n,a=e.x+s*o;a>=0&&a<=1&&r.push(s)}if(Math.abs(n)>1e-10){let s=(1-e.y)/n,a=e.x+s*o;a>=0&&a<=1&&r.push(s)}if(Math.abs(o)>1e-10){let s=-e.x/o,a=e.y+s*n;a>=0&&a<=1&&r.push(s)}if(Math.abs(o)>1e-10){let s=(1-e.x)/o,a=e.y+s*n;a>=0&&a<=1&&r.push(s)}return[...new Set(r.map(s=>Math.round(s*1e6)/1e6))].sort((s,a)=>s-a)}function nt(e,t,o,n,r){let i=Math.round(t.x*100),s=Math.round(t.y*100);return{stops:e.map(({position:l,color:m})=>`${T(m,1)} ${Math.round(l*100)}%`).join(", "),cssGeometry:`circle at ${i}% ${s}%`}}function it(e,t,o,n,r){let i=Math.round(t.x*100),s=Math.round(t.y*100),a=Math.atan2(o.y-t.y,o.x-t.x)*(180/Math.PI)+90;return{stops:e.map(({position:m,color:g})=>`${T(g,1)} ${Math.round(m*100)}%`).join(", "),cssGeometry:`from ${Math.round(a)}deg at ${i}% ${s}%`}}function st(e,t,o,n,r){let i=Math.round(t.x*100),s=Math.round(t.y*100);return{stops:e.map(({position:l,color:m})=>`${T(m,1)} ${Math.round(l*100)}%`).join(", "),cssGeometry:`ellipse at ${i}% ${s}%`}}function at(e){let t={...e,gradientStops:[...e.gradientStops].sort((r,i)=>r.position-i.position)},{stops:o,cssGeometry:n}=tt(t);switch(e.type){case"GRADIENT_LINEAR":return`linear-gradient(${n}, ${o})`;case"GRADIENT_RADIAL":return`radial-gradient(${n}, ${o})`;case"GRADIENT_ANGULAR":return`conic-gradient(${n}, ${o})`;case"GRADIENT_DIAMOND":return`radial-gradient(${n}, ${o})`;default:return`linear-gradient(0deg, ${o})`}}function Ie(e){if(!b("effects",e))return{};let t=e.effects.filter(l=>l.visible),o=t.filter(l=>l.type==="DROP_SHADOW").map(lt),n=t.filter(l=>l.type==="INNER_SHADOW").map(ct),r=[...o,...n].join(", "),i=t.filter(l=>l.type==="LAYER_BLUR").map(xe).join(" "),s=t.filter(l=>l.type==="BACKGROUND_BLUR").map(xe).join(" "),a={};return r&&(e.type==="TEXT"?a.textShadow=r:a.boxShadow=r),i&&(a.filter=i),s&&(a.backdropFilter=s),a}function lt(e){return`${e.offset.x}px ${e.offset.y}px ${e.radius}px ${e.spread??0}px ${T(e.color)}`}function ct(e){return`inset ${e.offset.x}px ${e.offset.y}px ${e.radius}px ${e.spread??0}px ${T(e.color)}`}function xe(e){return`blur(${e.radius}px)`}function Te(e){return e.type==="TEXT"}function X(e){return b("style",e)&&Object.keys(e.style).length>0}function we(e){if(b("characters",e,le))return e.characters}function Ae(e){if(X(e)){let t=e.style;return{fontFamily:t.fontFamily,fontWeight:t.fontWeight,fontSize:t.fontSize,lineHeight:"lineHeightPx"in t&&t.lineHeightPx&&t.fontSize?`${t.lineHeightPx/t.fontSize}em`:void 0,letterSpacing:t.letterSpacing&&t.letterSpacing!==0&&t.fontSize?`${t.letterSpacing/t.fontSize*100}%`:void 0,textCase:t.textCase,textAlignHorizontal:t.textAlignHorizontal,textAlignVertical:t.textAlignVertical}}}function C(e,t,o){let[n]=Object.entries(e.styles).find(([i,s])=>JSON.stringify(s)===JSON.stringify(t))??[];if(n)return n;let r=Z(o);return e.styles[r]=t,r}var V=(e,t,o)=>{let n=Se(e,o.parent);Object.keys(n).length>1&&(t.layout=C(o.globalVars,n,"layout"))},B=(e,t,o)=>{if(Te(e)&&(t.text=we(e)),X(e)){let n=Ae(e);if(n){let r=L(e,o,["text","typography"]);r?(o.globalVars.styles[r]=n,t.textStyle=r):t.textStyle=C(o.globalVars,n,"style")}}},Y=(e,t,o)=>{let n=b("children",e)&&Array.isArray(e.children)&&e.children.length>0;if(b("fills",e)&&Array.isArray(e.fills)&&e.fills.length){let s=e.fills.map(l=>K(l,n)).reverse(),a=L(e,o,["fill","fills"]);a?(o.globalVars.styles[a]=s,t.fills=a):t.fills=C(o.globalVars,s,"fill")}let r=be(e,n);if(r.colors.length){let s=L(e,o,["stroke","strokes"]);s?(o.globalVars.styles[s]=r.colors,t.strokes=s,r.strokeWeight&&(t.strokeWeight=r.strokeWeight),r.strokeDashes&&(t.strokeDashes=r.strokeDashes),r.strokeWeights&&(t.strokeWeights=r.strokeWeights)):t.strokes=C(o.globalVars,r,"stroke")}let i=Ie(e);if(Object.keys(i).length){let s=L(e,o,["effect","effects"]);s?(o.globalVars.styles[s]=i,t.effects=s):t.effects=C(o.globalVars,i,"effect")}b("opacity",e)&&typeof e.opacity=="number"&&e.opacity!==1&&(t.opacity=e.opacity),b("cornerRadius",e)&&typeof e.cornerRadius=="number"&&(t.borderRadius=`${e.cornerRadius}px`),b("rectangleCornerRadii",e,pe)&&(t.borderRadius=`${e.rectangleCornerRadii[0]}px ${e.rectangleCornerRadii[1]}px ${e.rectangleCornerRadii[2]}px ${e.rectangleCornerRadii[3]}px`)},Re=(e,t,o)=>{e.type==="INSTANCE"&&(b("componentId",e)&&(t.componentId=e.componentId),b("componentProperties",e)&&(t.componentProperties=Object.entries(e.componentProperties??{}).map(([n,{value:r,type:i}])=>({name:n,value:r.toString(),type:i}))))};function L(e,t,o){if(!b("styles",e))return;let n=e.styles;for(let r of o){let i=n[r];if(i){let s=t.globalVars.extraStyles?.[i];if(s?.name)return s.name}}}var J=[V,B,Y,Re],mt=[V,B],gt=[B],pt=[Y],ut=[V];import dt from"js-yaml";var ve={fileKey:H.string().describe("The key of the Figma file to fetch, often found in a provided URL like figma.com/(file|design)/<fileKey>/..."),nodeId:H.string().optional().describe("The ID of the node to fetch, often found as URL parameter node-id=<nodeId>, always use if provided"),depth:H.number().optional().describe("OPTIONAL. Do NOT use unless explicitly requested by the user. Controls how many levels deep to traverse the node tree.")},Mo=H.object(ve);async function ft(e,t,o){try{let{fileKey:n,nodeId:r,depth:i}=e;c.log(`Fetching ${i?`${i} layers deep`:"all layers"} of ${r?`node ${r} from file`:"full file"} ${n}`);let s;r?s=await t.getRawNode(n,r,i):s=await t.getRawFile(n,i);let a=q(s,J,{maxDepth:i});$("figma-simplified.json",a),c.log(`Successfully extracted data: ${a.nodes.length} nodes, ${Object.keys(a.globalVars.styles).length} styles`);let{nodes:l,globalVars:m,...g}=a,f={metadata:g,nodes:l,globalVars:m};c.log(`Generating ${o.toUpperCase()} result from extracted data`);let p=o==="json"?JSON.stringify(f,null,2):dt.dump(f);return c.log("Sending result to client"),{content:[{type:"text",text:p}]}}catch(n){let r=n instanceof Error?n.message:JSON.stringify(n);return c.error(`Error fetching file ${e.fileKey}:`,r),{isError:!0,content:[{type:"text",text:`Error fetching file: ${r}`}]}}}var E={name:"get_figma_data",description:"Get comprehensive Figma file data including layout, content, visuals, and component information",parameters:ve,handler:ft};import{z as I}from"zod";var Fe={fileKey:I.string().regex(/^[a-zA-Z0-9]+$/,"File key must be alphanumeric").describe("The key of the Figma file containing the images"),nodes:I.object({nodeId:I.string().regex(/^I?\d+:\d+(?:;\d+:\d+)*$/,"Node ID must be like '1234:5678' or 'I5666:180910;1:10515;1:10336'").describe("The ID of the Figma image node to fetch, formatted as 1234:5678"),imageRef:I.string().optional().describe("If a node has an imageRef fill, you must include this variable. Leave blank when downloading Vector SVG images."),fileName:I.string().regex(/^[a-zA-Z0-9_.-]+$/,"File name can only contain alphanumeric characters, underscores, dots, and hyphens").describe("The local name for saving the fetched file, including extension. Either png or svg."),needsCropping:I.boolean().optional().describe("Whether this image needs cropping based on its transform matrix"),cropTransform:I.array(I.array(I.number())).optional().describe("Figma transform matrix for image cropping"),requiresImageDimensions:I.boolean().optional().describe("Whether this image requires dimension information for CSS variables"),filenameSuffix:I.string().optional().describe("Suffix to add to filename for unique cropped images, provided in the Figma data (e.g., 'abc123')")}).array().describe("The nodes to fetch as images"),pngScale:I.number().positive().optional().default(2).describe("Export scale for PNG images. Optional, defaults to 2 if not specified. Affects PNG images only."),localPath:I.string().describe("The absolute path to the directory where images are stored in the project. If the directory does not exist, it will be created. The format of this path should respect the directory format of the operating system you are running on. Don't use any special character escaping in the path name either.")},_o=I.object(Fe);async function ht(e,t){try{let{fileKey:o,nodes:n,localPath:r,pngScale:i=2}=e,s=[],a=new Map,l=new Map;for(let p of n){let u=p.fileName;if(p.filenameSuffix&&!u.includes(p.filenameSuffix)){let d=u.split(".").pop();u=`${u.substring(0,u.lastIndexOf("."))}-${p.filenameSuffix}.${d}`}let h={fileName:u,needsCropping:p.needsCropping||!1,cropTransform:p.cropTransform,requiresImageDimensions:p.requiresImageDimensions||!1};if(p.imageRef){let d=`${p.imageRef}-${p.filenameSuffix||"none"}`;if(!p.filenameSuffix&&l.has(d)){let y=l.get(d),S=a.get(y);S.includes(u)||S.push(u),h.requiresImageDimensions&&(s[y].requiresImageDimensions=!0)}else{let y=s.length;s.push({...h,imageRef:p.imageRef}),a.set(y,[u]),l.set(d,y)}}else{let d=s.length;s.push({...h,nodeId:p.nodeId}),a.set(d,[u])}}let m=await t.downloadImages(o,r,s,{pngScale:i}),g=m.filter(Boolean).length,f=m.map((p,u)=>{let h=p.filePath.split("/").pop()||p.filePath,d=`${p.finalDimensions.width}x${p.finalDimensions.height}`,y=p.wasCropped?" (cropped)":"",S=p.cssVariables?`${d} | ${p.cssVariables}`:d,w=a.get(u)||[h],A=w.length>1?` (also requested as: ${w.filter(x=>x!==h).join(", ")})`:"";return`- ${h}: ${S}${y}${A}`}).join(`
`);return{content:[{type:"text",text:`Downloaded ${g} images:
${f}`}]}}catch(o){return c.error(`Error downloading images from ${e.fileKey}:`,o),{isError:!0,content:[{type:"text",text:`Failed to download images: ${o instanceof Error?o.message:String(o)}`}]}}}var N={name:"download_figma_images",description:"Download SVG and PNG images used in a Figma file based on the IDs of image or icon nodes",parameters:Fe,handler:ht};var St={name:"Figma MCP Server",version:"0.6.0"};function De(e,{isHTTP:t=!1,outputFormat:o="yaml",skipImageDownloads:n=!1}={}){let r=new yt(St),i=new G(e);return bt(r,i,{outputFormat:o,skipImageDownloads:n}),c.isHTTP=t,r}function bt(e,t,o){e.tool(E.name,E.description,E.parameters,n=>E.handler(n,t,o.outputFormat)),o.skipImageDownloads||e.tool(N.name,N.description,N.parameters,n=>N.handler(n,t))}It({path:Tt(process.cwd(),".env")});async function wt(){let e=process.env.NODE_ENV==="cli"||process.argv.includes("--stdio"),t=te(e),o=De(t.auth,{isHTTP:!e,outputFormat:t.outputFormat,skipImageDownloads:t.skipImageDownloads});if(e){let n=new xt;await o.connect(n)}else console.log(`Initializing Figma MCP Server in HTTP mode on port ${t.port}...`),await ne(t.port,o)}process.argv[1]&&wt().catch(e=>{console.error("Failed to start server:",e),process.exit(1)});export{te as a,W as b,q as c,V as d,B as e,Y as f,Re as g,J as h,mt as i,gt as j,pt as k,ut as l,De as m,wt as n};
